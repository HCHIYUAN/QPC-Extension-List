import React, { useState, useEffect, useMemo } from 'react';
import { Search, Phone, User, Building, Plus, Upload, Trash2, Edit2, Save, X, Download, FileText, Layers, RotateCcw, HelpCircle, Settings, ChevronDown, ChevronUp } from 'lucide-react';

// é è¨­è³‡æ–™
const DEFAULT_DATA = [
  { id: '300', unit: 'æ¥­æœ¬éƒ¨', ext: '300', name: 'è‘£äº‹é•·', note: '' },
  { id: '301', unit: 'æ¥­æœ¬éƒ¨', ext: '301', name: 'é‚±éœæ€¡', note: '' },
  { id: '302', unit: 'æ¥­æœ¬éƒ¨', ext: '302', name: 'åŠ‰ä¼Šç¥', note: '#6940' },
  { id: '303', unit: 'æ¥­æœ¬éƒ¨', ext: '303', name: 'ç‹ä¿®å‡¡', note: '' },
  { id: '305', unit: 'æ¥­æœ¬éƒ¨', ext: '305', name: 'é«˜è‘£äº‹', note: '' },
  { id: '306', unit: 'æ¥­æœ¬éƒ¨', ext: '306', name: 'éƒ­å‰¯ç¸½', note: '' },
  { id: '307', unit: 'æ¥­æœ¬éƒ¨', ext: '307', name: 'è³´ç‰¹åŠ©', note: '' },
  { id: '308', unit: 'æ¥­æœ¬éƒ¨', ext: '308', name: 'æ½˜ç‰¹åŠ©', note: '' },
  { id: '311', unit: 'æ¥­æœ¬éƒ¨', ext: '311', name: 'é™³é¡§å•', note: '' },
  { id: '312', unit: 'æ¥­æœ¬éƒ¨', ext: '312', name: 'é„­ç‰¹åŠ©', note: '' },
  { id: '330', unit: 'æ¥­æœ¬éƒ¨', ext: '330', name: 'å³æ·‘è•™', note: '' },
  { id: '350', unit: 'æ¥­æœ¬éƒ¨', ext: '350', name: 'å¤§æœƒè­°å®¤', note: '' },
  { id: '351', unit: 'æ¥­æœ¬éƒ¨', ext: '351', name: 'æœƒè­°å®¤', note: '' },
  { id: '352', unit: 'æ¥­æœ¬éƒ¨', ext: '352', name: 'æœƒå®¢å®¤', note: '' },
  
  { id: '200', unit: 'ç­–ç•¥ä¼åŠƒéƒ¨', ext: '200', name: 'ç‹ç¸½ç¶“ç†', note: '' },
  { id: '202', unit: 'ç­–ç•¥ä¼åŠƒéƒ¨', ext: '202', name: 'ç‹çµ®å¹³', note: '' },
  { id: '203', unit: 'ç­–ç•¥ä¼åŠƒéƒ¨', ext: '203', name: 'å”è‚²å´§', note: '' },
  { id: '205', unit: 'ç­–ç•¥ä¼åŠƒéƒ¨', ext: '205', name: 'è¿°è·äººå“¡', note: '' },
  { id: '207', unit: 'ç­–ç•¥ä¼åŠƒéƒ¨', ext: '207', name: 'ç‹æ…ˆè‹‘', note: '' },
  { id: '208', unit: 'ç­–ç•¥ä¼åŠƒéƒ¨', ext: '208', name: 'éŸ‹ä¿Šæ–Œ', note: '' },

  { id: '230', unit: 'è³‡è¨Šå®¤', ext: '230', name: 'æç‚¯æ˜', note: '' },
  { id: '231', unit: 'è³‡è¨Šå®¤', ext: '231', name: 'é„­å‡±å‹»', note: '' },
  { id: '232', unit: 'è³‡è¨Šå®¤', ext: '232', name: 'æä½³é´»', note: '' },
  { id: '233', unit: 'è³‡è¨Šå®¤', ext: '233', name: 'è³‡è¨Šå®¤æ©Ÿæˆ¿', note: '' },

  { id: '500', unit: 'ç ”ç™¼éƒ¨', ext: '500', name: 'è¬ä¿Šå‚‘', note: '#6900' },
  { id: '501', unit: 'ç ”ç™¼éƒ¨', ext: '501', name: 'æ½˜äº­æº±', note: '' },
  { id: '502', unit: 'ç ”ç™¼éƒ¨', ext: '502', name: 'æ½˜æ·‘è²', note: '' },
  { id: '503', unit: 'ç ”ç™¼éƒ¨', ext: '503', name: 'é‚±ç™¾è±', note: '' },
  { id: '510', unit: 'ç ”ç™¼éƒ¨', ext: '510', name: 'é™³æ˜­å®‰', note: '#6927' },
  { id: '531', unit: 'ç ”ç™¼éƒ¨', ext: '531', name: 'å³ç‰æ°‘', note: '' },
  { id: '532', unit: 'ç ”ç™¼éƒ¨', ext: '532', name: 'é„§æ•è°', note: '' },
  { id: '533', unit: 'ç ”ç™¼éƒ¨', ext: '533', name: 'è‘‰å­æ­£/æ–¹æ–é”', note: '#6906' },
  { id: '540', unit: 'ç ”ç™¼éƒ¨', ext: '540', name: 'é™³ç¦ç³', note: '#6943' },
  { id: '541', unit: 'ç ”ç™¼éƒ¨', ext: '541', name: 'ç ”ç™¼4Fæœƒè­°å®¤', note: '' },
  { id: '542', unit: 'ç ”ç™¼éƒ¨', ext: '542', name: 'å¯¦é©—å®¤ä¸‰', note: '' },
  { id: '543', unit: 'ç ”ç™¼éƒ¨', ext: '543', name: 'è¨±å®¶ç‘‹', note: '' },
  { id: '545', unit: 'ç ”ç™¼éƒ¨', ext: '545', name: 'å³æ–‡æ°/è©¹å²³å‹³', note: '#6916/#6921' },
  { id: '546', unit: 'ç ”ç™¼éƒ¨', ext: '546', name: 'ç”°åŸè/è‘£å¿—é¾', note: '' },
  { id: '547', unit: 'ç ”ç™¼éƒ¨', ext: '547', name: 'è¬éƒå®‰/é¡å˜‰èˆˆ', note: '#6934' },
  { id: '570', unit: 'ç ”ç™¼éƒ¨', ext: '570', name: '5Fè²´é‡å„€å™¨å®¤', note: '' },
  { id: '571', unit: 'ç ”ç™¼éƒ¨', ext: '571', name: 'èŠå¿—æˆ', note: '' },
  { id: '572', unit: 'ç ”ç™¼éƒ¨', ext: '572', name: '5Få¯¦é©—å®¤å››', note: '' },
  { id: '573', unit: 'ç ”ç™¼éƒ¨', ext: '573', name: 'ç›§ç¾©é›„', note: '#6915' },
  { id: '575', unit: 'ç ”ç™¼éƒ¨', ext: '575', name: '5æ¨“EIå¯¦é©—å®¤', note: '' },

  { id: '101', unit: 'è³‡æèª²', ext: '101', name: 'æ¥Šæ­£å ‚', note: '#6705' },
  { id: '102', unit: 'è³‡æèª²', ext: '102', name: 'è”¡æ”¿ç©/é™³æ˜æ¯…', note: '' },
  { id: '103', unit: 'è³‡æèª²', ext: '103', name: 'éƒ­éˆºæº±', note: '' },
  { id: '105', unit: 'è³‡æèª²', ext: '105', name: 'ç¨‹è®Œè€', note: '' },

  { id: '610', unit: 'ç”Ÿç”¢éƒ¨ç¾å ´', ext: '610', name: 'ç”Ÿä¸€èª²æ§åˆ¶å®¤', note: '' },
  { id: '611', unit: 'ç”Ÿç”¢éƒ¨ç¾å ´', ext: '611', name: 'ç”Ÿä¸€èª²æ¡æ¨£å®¤', note: '' },
  { id: '620', unit: 'ç”Ÿç”¢éƒ¨ç¾å ´', ext: '620', name: 'ç”ŸäºŒèª²æ§åˆ¶å®¤', note: '' },
  { id: '621', unit: 'ç”Ÿç”¢éƒ¨ç¾å ´', ext: '621', name: 'ç”ŸäºŒèª²æ¡æ¨£å®¤', note: '' },
  { id: '630', unit: 'ç”Ÿç”¢éƒ¨ç¾å ´', ext: '630', name: 'ç”Ÿä¸‰èª²æ§åˆ¶å®¤', note: '' },

  { id: '210', unit: 'ç‡Ÿæ¥­éƒ¨-å…§éŠ·', ext: '210', name: 'è˜‡ä¿¡é¾', note: '#6880' },
  
  { id: '901', unit: 'å¤–éƒ¨å–®ä½', ext: '#6 110', name: 'æ°¸å®‰åˆ†é§æ‰€', note: '' },
  { id: '902', unit: 'å¤–éƒ¨å–®ä½', ext: '#6 119', name: 'æ°¸å®‰æ¶ˆé˜²éšŠ', note: '' },
  { id: '903', unit: 'å¤–éƒ¨å–®ä½', ext: '07-6212895', name: 'æ°¸å®‰æœå‹™ä¸­å¿ƒ', note: '' },
  { id: '904', unit: 'å…¬å…±è¨­æ–½', ext: '885', name: 'è¾¦å…¬å®¤å®¢æ¢¯å…§ç·š', note: '' },
  { id: '905', unit: 'å…¬å…±è¨­æ–½', ext: '695', name: 'æˆå“å€‰åº«è²¨æ¢¯', note: '' },
];

const CompanyDirectory = () => {
  const [contacts, setContacts] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedUnit, setSelectedUnit] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingContact, setEditingContact] = useState(null);
  const [encoding, setEncoding] = useState('big5');
  const [showFormatHint, setShowFormatHint] = useState(false);
  const [isManageMode, setIsManageMode] = useState(false); // æ§åˆ¶ç®¡ç†é¢æ¿é¡¯ç¤º
  
  useEffect(() => {
    const savedData = localStorage.getItem('companyContacts');
    if (savedData) {
      setContacts(JSON.parse(savedData));
    } else {
      setContacts(DEFAULT_DATA);
    }
  }, []);

  useEffect(() => {
    if (contacts.length > 0) {
      localStorage.setItem('companyContacts', JSON.stringify(contacts));
    }
  }, [contacts]);

  const allUnits = useMemo(() => {
    const units = [...new Set(contacts.map(c => c.unit).filter(u => u && u.trim() !== ''))];
    return units.sort();
  }, [contacts]);

  // è§£æ CSV
  const parseCSV = (text) => {
    const lines = text.split('\n');
    const newContacts = [];
    let mode = 'unknown';

    const firstLine = lines[0]?.trim();
    if (firstLine && firstLine.split(',').length > 6) {
      mode = 'legacy'; 
    } else {
      mode = 'standard';
    }

    lines.forEach((line, index) => {
      const cleanLine = line.replace('\r', '');
      if (!cleanLine.trim()) return;
      
      const row = cleanLine.split(',').map(cell => 
        cell.trim().replace(/^"|"$/g, '') 
      );
      
      if (mode === 'legacy') {
        for (let i = 0; i < row.length; i += 4) {
          const unit = row[i]?.trim();
          let ext = row[i+1]?.trim();
          const nameRaw = row[i+2]?.trim();

          if (unit && ext && nameRaw && unit !== 'å–®ä½' && ext !== 'åˆ†æ©Ÿ') {
             ext = ext.replace('.0', '');
             newContacts.push({
               id: Date.now() + Math.random().toString(36).substr(2, 9) + i,
               unit: unit,
               ext: ext,
               name: nameRaw,
               note: ''
             });
          }
        }
      } else {
        const col0 = row[0]; // éƒ¨é–€
        const col1 = row[1]; // å§“å
        let name = col1;
        let ext = row[2];
        let note = row[3];
        
        if (col1 && !isNaN(col1) && isNaN(row[2])) {
           ext = col1;
           name = row[2];
        } else if (col1 && col1.includes('åˆ†æ©Ÿ')) {
           return; 
        }

        if (col0 && name && ext) {
           if (['éƒ¨é–€', 'å–®ä½', 'Unit'].includes(col0) || ['åˆ†æ©Ÿ'].includes(ext)) return;

           newContacts.push({
             id: Date.now() + Math.random().toString(36).substr(2, 9) + index,
             unit: col0,
             name: name,
             ext: ext.replace('.0', ''),
             note: note || ''
           });
        }
      }
    });

    return { contacts: newContacts, mode };
  };

  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.readAsText(file, encoding);

    reader.onload = (e) => {
      const text = e.target.result;
      if (text.includes('') && text.length > 20) {
        alert('è­¦å‘Šï¼šåµæ¸¬åˆ°äº‚ç¢¼ï¼Œè«‹å˜—è©¦åˆ‡æ›ã€Œç·¨ç¢¼æ ¼å¼ã€å¾Œé‡æ–°åŒ¯å…¥ã€‚');
      }
      const { contacts: newContacts, mode } = parseCSV(text);
      if (newContacts.length > 0) {
        const msg = mode === 'legacy' 
          ? `åµæ¸¬åˆ°ã€ŒèˆŠç‰ˆæ’ç‰ˆæ ¼å¼ã€ï¼ŒæˆåŠŸè§£æ ${newContacts.length} ç­†è³‡æ–™ã€‚`
          : `åµæ¸¬åˆ°ã€Œæ¨™æº–æ¸…å–®æ ¼å¼ã€ï¼ŒæˆåŠŸè§£æ ${newContacts.length} ç­†è³‡æ–™ã€‚`;

        if (window.confirm(`${msg}\næ˜¯å¦è¦è¦†è“‹ç¾æœ‰è³‡æ–™ï¼Ÿ(é¸æ“‡ã€Œå–æ¶ˆã€å‰‡æœƒåŠ å…¥åˆ°ç¾æœ‰è³‡æ–™å¾Œ)`)) {
           setContacts(newContacts);
        } else {
           setContacts(prev => [...prev, ...newContacts]);
        }
        setSelectedUnit(null);
      } else {
        alert('è§£æå¤±æ•—ã€‚è«‹ç¢ºèªæª”æ¡ˆç·¨ç¢¼æ˜¯å¦æ­£ç¢ºï¼Œæˆ–æª”æ¡ˆå…§å®¹æ˜¯å¦ç¬¦åˆæ ¼å¼ã€‚');
      }
    };
  };

  const filteredContacts = useMemo(() => {
    const lowerSearch = searchTerm.toLowerCase();
    return contacts.filter(contact => {
      const matchesUnit = selectedUnit ? contact.unit === selectedUnit : true;
      const matchesSearch = 
        contact.name.toLowerCase().includes(lowerSearch) ||
        contact.ext.includes(lowerSearch) ||
        contact.unit.toLowerCase().includes(lowerSearch) ||
        (contact.note && contact.note.toLowerCase().includes(lowerSearch));
      return matchesUnit && matchesSearch;
    });
  }, [contacts, searchTerm, selectedUnit]);

  const handleDelete = (id) => {
    if (window.confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¯çµ¡äººå—ï¼Ÿ')) {
      setContacts(contacts.filter(c => c.id !== id));
    }
  };

  const handleSave = (contact) => {
    if (editingContact) {
      setContacts(contacts.map(c => c.id === contact.id ? contact : c));
    } else {
      setContacts([...contacts, { ...contact, id: Date.now().toString() }]);
    }
    setIsModalOpen(false);
    setEditingContact(null);
  };

  const openAddModal = () => {
    setEditingContact(null);
    setIsModalOpen(true);
  };

  const openEditModal = (contact) => {
    setEditingContact(contact);
    setIsModalOpen(true);
  };

  const exportCSV = () => {
    const header = "éƒ¨é–€,å§“å,åˆ†æ©Ÿ,å‚™è¨»\n";
    const rows = contacts.map(c => `${c.unit},${c.name},${c.ext},${c.note || ''}`).join("\n");
    const blob = new Blob(["\ufeff" + header + rows], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', 'å…¬å¸é€šè¨ŠéŒ„_æ¨™æº–æ ¼å¼.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-12">
      {/* Header - æ¥µç°¡åŒ– */}
      <header className="bg-blue-600 text-white shadow-md sticky top-0 z-20">
        <div className="max-w-6xl mx-auto px-4 py-3">
          <div className="flex justify-between items-center mb-3">
            <h1 
              className="text-xl font-bold flex items-center gap-2 cursor-pointer hover:opacity-90 transition" 
              onClick={() => {setSelectedUnit(null); setSearchTerm('')}}
            >
              <Phone className="w-5 h-5" />
              å…¬å¸åˆ†æ©Ÿè¡¨
            </h1>
            
            <button 
              onClick={() => setIsManageMode(!isManageMode)}
              className={`p-2 rounded-lg transition text-blue-100 hover:bg-blue-500 hover:text-white ${isManageMode ? 'bg-blue-700 text-white' : ''}`}
              title="ç®¡ç†è³‡æ–™"
            >
              {isManageMode ? <ChevronUp className="w-5 h-5" /> : <Settings className="w-5 h-5" />}
            </button>
          </div>

          {/* Search Bar - å…¨å¯¬ */}
          <div className="relative w-full">
            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <Search className="h-4 w-4 text-blue-200" />
            </div>
            <input
              type="text"
              className="block w-full pl-9 pr-8 py-2.5 border-none rounded-lg leading-5 bg-blue-700/50 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-white focus:bg-blue-600 sm:text-sm transition duration-150 ease-in-out"
              placeholder="æœå°‹å§“åã€åˆ†æ©Ÿæˆ–éƒ¨é–€..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
            {searchTerm && (
              <button 
                onClick={() => setSearchTerm('')}
                className="absolute inset-y-0 right-0 pr-2.5 flex items-center text-blue-300 hover:text-white"
              >
                <X className="w-4 h-4" />
              </button>
            )}
          </div>
        </div>
      </header>

      {/* ç®¡ç†é¢æ¿ (å¯æ”¶åˆ) */}
      <div className={`bg-white border-b border-slate-200 overflow-hidden transition-all duration-300 ease-in-out ${isManageMode ? 'max-h-96 opacity-100' : 'max-h-0 opacity-0'}`}>
        <div className="max-w-6xl mx-auto px-4 py-4 space-y-4">
           <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
             <Settings className="w-4 h-4" /> è³‡æ–™ç®¡ç†
           </h3>
           <div className="flex flex-wrap gap-3 items-center">
               <button onClick={openAddModal} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm transition shadow-sm">
                  <Plus className="w-4 h-4" />
                  æ–°å¢è¯çµ¡äºº
               </button>

               <div className="h-6 w-px bg-slate-300 mx-1 hidden sm:block"></div>

               <div className="flex items-center bg-slate-50 border border-slate-300 rounded-lg px-2 py-1.5 shadow-sm">
                  <span className="text-xs text-slate-500 mr-2">ç·¨ç¢¼:</span>
                  <select 
                    value={encoding} 
                    onChange={(e) => setEncoding(e.target.value)}
                    className="text-sm bg-transparent border-none focus:ring-0 text-slate-700 cursor-pointer outline-none p-0"
                  >
                    <option value="big5">Big5 (Excelé è¨­)</option>
                    <option value="utf-8">UTF-8 (é€šç”¨)</option>
                  </select>
               </div>

               <label className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-50 text-slate-600 text-sm transition shadow-sm">
                  <Upload className="w-4 h-4" />
                  <span>åŒ¯å…¥ CSV</span>
                  <input key={encoding} type="file" accept=".csv,.txt" className="hidden" onChange={handleFileUpload} />
               </label>
               
               <button onClick={exportCSV} className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 text-slate-600 text-sm transition shadow-sm">
                  <Download className="w-4 h-4" />
                  åŒ¯å‡ºå‚™ä»½
               </button>

               <button onClick={() => setShowFormatHint(!showFormatHint)} className="p-2 text-slate-400 hover:text-blue-600 transition ml-auto">
                  <HelpCircle className="w-5 h-5" />
               </button>
           </div>
           
           {/* æ ¼å¼æç¤ºå€å¡Š - ç§»åˆ°ç®¡ç†é¢æ¿å…§ */}
           {showFormatHint && (
            <div className="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-slate-700 animate-in fade-in slide-in-from-top-2">
               <p className="mb-2 font-bold text-blue-800">ğŸ’¡ å»ºè­°æ¬„ä½é †åº (4æ¬„):</p>
               <p className="text-xs text-slate-600">A:éƒ¨é–€ | B:å§“å | C:åˆ†æ©Ÿ | D:å‚™è¨»</p>
            </div>
           )}
        </div>
      </div>

      <main className="max-w-6xl mx-auto px-4 pt-4">
        
        {/* éƒ¨é–€ç¯©é¸ - é¡ä¼¼ Tab çš„æ»‘å‹•è¨­è¨ˆ */}
        {allUnits.length > 0 && (
          <div className="mb-6 overflow-x-auto pb-2 -mx-4 px-4 scrollbar-hide">
            <div className="flex space-x-2">
              <button
                onClick={() => setSelectedUnit(null)}
                className={`flex-shrink-0 px-4 py-1.5 rounded-full text-sm font-medium transition-colors border ${
                  !selectedUnit 
                    ? 'bg-slate-800 text-white border-slate-800 shadow-sm' 
                    : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-100'
                }`}
              >
                å…¨éƒ¨
              </button>
              {allUnits.map(unit => {
                const isSelected = selectedUnit === unit;
                return (
                  <button
                    key={unit}
                    onClick={() => setSelectedUnit(unit)}
                    className={`flex-shrink-0 px-4 py-1.5 rounded-full text-sm font-medium transition-colors border ${
                      isSelected
                      ? 'bg-blue-600 text-white border-blue-600 shadow-sm'
                      : 'bg-white text-slate-600 border-slate-200 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200'
                    }`}
                  >
                    {unit}
                  </button>
                );
              })}
            </div>
          </div>
        )}

        {/* ç¯©é¸ç‹€æ…‹æç¤º */}
        {(selectedUnit || searchTerm) && (
          <div className="flex items-center justify-between mb-4 text-sm text-slate-500 px-1">
            <div className="flex items-center gap-2">
               <span>
                  {selectedUnit && `ğŸ“‚ ${selectedUnit}`}
                  {selectedUnit && searchTerm && ' + '}
                  {searchTerm && `ğŸ” "${searchTerm}"`}
               </span>
               <span className="text-xs bg-slate-100 px-2 py-0.5 rounded-full">
                  {filteredContacts.length} ç­†
               </span>
            </div>
            <button 
              onClick={() => {setSelectedUnit(null); setSearchTerm('');}}
              className="text-xs text-blue-500 hover:underline flex items-center gap-1"
            >
              <RotateCcw className="w-3 h-3" /> æ¸…é™¤
            </button>
          </div>
        )}

        {/* Contact Grid */}
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          {filteredContacts.length > 0 ? (
            filteredContacts.map((contact) => (
              <div key={contact.id} className="bg-white rounded-lg shadow-sm border border-slate-200 p-3.5 flex items-center justify-between hover:shadow-md transition duration-200 group relative">
                 {/* ç·¨è¼¯/åˆªé™¤æŒ‰éˆ• - åªè¦æ»‘é¼ ç§»éå»å°±æœƒå‡ºç¾ (opacity-0 -> 100) */}
                 <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200 bg-white/90 backdrop-blur-sm rounded-lg p-1 shadow-sm border border-slate-100">
                    <button 
                      onClick={() => openEditModal(contact)} 
                      className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-md transition-colors"
                      title="ç·¨è¼¯"
                    >
                      <Edit2 className="w-3.5 h-3.5" />
                    </button>
                    <button 
                      onClick={() => handleDelete(contact.id)} 
                      className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-md transition-colors"
                      title="åˆªé™¤"
                    >
                      <Trash2 className="w-3.5 h-3.5" />
                    </button>
                 </div>

                 <div className="flex items-center gap-3 overflow-hidden">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold shrink-0 text-white text-sm shadow-sm ${
                      selectedUnit === contact.unit ? 'bg-blue-500' : 'bg-slate-400'
                    }`}>
                       {contact.name.charAt(0)}
                    </div>
                    <div className="min-w-0">
                       <h3 className="font-bold text-slate-800 truncate">{contact.name}</h3>
                       <div className="text-xs text-slate-500 truncate flex items-center gap-1">
                         {contact.unit}
                         {contact.note && <span className="text-slate-300">|</span>}
                         {contact.note && <span className="text-orange-400">{contact.note}</span>}
                       </div>
                    </div>
                 </div>
                 
                 <div className="pl-2 text-right">
                    <a href={`tel:${contact.ext.split('#')[0]}`} className="block text-xl font-bold text-blue-600 font-mono hover:underline decoration-2 underline-offset-2">
                       {contact.ext}
                    </a>
                 </div>
              </div>
            ))
          ) : (
            <div className="col-span-full py-10 text-center text-slate-400">
              <p>æŸ¥ç„¡è³‡æ–™</p>
            </div>
          )}
        </div>
      </main>

      {/* Modal */}
      {isModalOpen && (
        <ContactModal 
          isOpen={isModalOpen} 
          onClose={() => setIsModalOpen(false)} 
          onSave={handleSave}
          initialData={editingContact}
          existingUnits={allUnits}
        />
      )}
    </div>
  );
};

// Modal Component - ä¿æŒä¸è®Š
const ContactModal = ({ isOpen, onClose, onSave, initialData, existingUnits = [] }) => {
  const [formData, setFormData] = useState({
    unit: '',
    ext: '',
    name: '',
    note: ''
  });

  useEffect(() => {
    if (initialData) {
      setFormData(initialData);
    } else {
      setFormData({ unit: '', ext: '', name: '', note: '' });
    }
  }, [initialData]);

  const handleSubmit = (e) => {
    e.preventDefault();
    onSave({ ...formData, id: initialData?.id });
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
      <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
          <h3 className="font-bold text-lg text-slate-800">
            {initialData ? 'ç·¨è¼¯è¯çµ¡äºº' : 'æ–°å¢è¯çµ¡äºº'}
          </h3>
          <button onClick={onClose} className="text-slate-400 hover:text-slate-600">
            <X className="w-5 h-5" />
          </button>
        </div>
        
        <form onSubmit={handleSubmit} className="p-6 space-y-4">
          <div>
            <label className="block text-sm font-medium text-slate-700 mb-1">éƒ¨é–€ / å–®ä½</label>
            <div className="relative">
               <Building className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
               <input 
                 required
                 type="text" 
                 list="units-datalist"
                 className="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                 placeholder="ä¾‹å¦‚ï¼šè³‡è¨Šå®¤"
                 value={formData.unit}
                 onChange={e => setFormData({...formData, unit: e.target.value})}
               />
               <datalist id="units-datalist">
                 {existingUnits.map(u => <option key={u} value={u} />)}
               </datalist>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
             <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">ä½¿ç”¨äººå§“å</label>
                <div className="relative">
                   <User className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                   <input 
                     required
                     type="text" 
                     className="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                     placeholder="å§“å"
                     value={formData.name}
                     onChange={e => setFormData({...formData, name: e.target.value})}
                   />
                </div>
             </div>
             <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">åˆ†æ©Ÿè™Ÿç¢¼</label>
                <div className="relative">
                   <Phone className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                   <input 
                     required
                     type="text" 
                     className="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                     placeholder="ä¾‹å¦‚ï¼š300"
                     value={formData.ext}
                     onChange={e => setFormData({...formData, ext: e.target.value})}
                   />
                </div>
             </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-slate-700 mb-1">å‚™è¨» (é¸å¡«)</label>
            <textarea 
              className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
              rows="2"
              placeholder="ä¾‹å¦‚ï¼šæ‰‹æ©Ÿè™Ÿç¢¼ã€è·å‹™ä»£ç†äºº..."
              value={formData.note}
              onChange={e => setFormData({...formData, note: e.target.value})}
            ></textarea>
          </div>

          <div className="pt-4 flex justify-end gap-3">
            <button 
              type="button" 
              onClick={onClose}
              className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition"
            >
              å–æ¶ˆ
            </button>
            <button 
              type="submit"
              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md hover:shadow-lg transition flex items-center gap-2"
            >
              <Save className="w-4 h-4" />
              å„²å­˜
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default CompanyDirectory;
