<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- åŠ å…¥ viewport-fit=cover ä»¥é©é… iPhone ç€æµ·å…¨è¢å¹• -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="å…¬å¸åˆ†æ©Ÿé€šè¨ŠéŒ„æŸ¥è©¢ç³»çµ±">
    
    <!-- === å¼·åˆ¶æ¸…é™¤å¿«å–è¨­å®š === -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <!-- === PWA èˆ‡ åŸç”Ÿ App è¨­å®š (é—œéµ) === -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#2563eb" />
    
    <!-- iOS å°ˆç”¨è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    
    <title>å…¬å¸åˆ†æ©Ÿè¡¨</title>
    
    <!-- è¨­å®š App åœ–ç¤º -->
    <link rel="icon" href="icon.png?v=3" type="image/png" />
    <link rel="apple-touch-icon" href="icon.png?v=3" />
    
    <!-- 1. è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ React å’Œ ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. è¼‰å…¥ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. è¼‰å…¥ Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        /* éš±è—æ»¾å‹•æ¢ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* === App è³ªæ„Ÿæ ¸å¿ƒ CSS === */
        body { 
            background-color: #f8fafc; 
            /* ç§»é™¤é»æ“Šé«˜äº® */
            -webkit-tap-highlight-color: transparent; 
            /* ç¦æ­¢ä¸‹æ‹‰é‡æ–°æ•´ç†/å›å½ˆæ•ˆæœ */
            overscroll-behavior-y: none;
            /* ç¦æ­¢é¸å–æ–‡å­— (åƒåŸç”ŸAppä¸€æ¨£) */
            user-select: none;
            -webkit-user-select: none;
            /* ç¦æ­¢é•·æŒ‰è·³å‡ºé¸å–® */
            -webkit-touch-callout: none;
            /* ä½¿ç”¨ç³»çµ±å­—é«” */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            /* ç¢ºä¿å¡«æ»¿ç•«é¢ */
            min-height: 100vh;
            /* é©é… iPhone å®‰å…¨å€åŸŸ */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* æ¢å¾©è¼¸å…¥æ¡†çš„æ–‡å­—é¸å–åŠŸèƒ½ */
        input, textarea {
            user-select: text;
            -webkit-user-select: text;
        }

        /* éª¨æ¶å±å‹•ç•« */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .skeleton {
            animation: shimmer 2s infinite linear;
            background: linear-gradient(to right, #f1f5f9 4%, #e2e8f0 25%, #f1f5f9 36%);
            background-size: 1000px 100%;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 5. ä¸»ç¨‹å¼ç¢¼ -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const APP_VERSION = "v2.4 (Native Feel)";

        // --- Firebase è¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyC-x0z9zteIwGoYgjk4iRMw1cCCkkSFPYI",
            authDomain: "qpc-extension-list.firebaseapp.com",
            projectId: "qpc-extension-list",
            storageBucket: "qpc-extension-list.firebasestorage.app",
            messagingSenderId: "828295398804",
            appId: "1:828295398804:web:8523c24def546ef48bbb81"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const COLLECTION_NAME = "contacts"; 

        // --- éŒ¯èª¤é‚Šç•Œå…ƒä»¶ ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("ErrorBoundary caught error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-slate-50 text-slate-800">
                            <div className="bg-white p-6 rounded-xl shadow-lg max-w-sm w-full border-l-4 border-red-500">
                                <h2 className="text-xl font-bold text-red-600 mb-2">âš ï¸ ç™¼ç”ŸéŒ¯èª¤</h2>
                                <p className="text-sm text-slate-600 mb-4">æ‡‰ç”¨ç¨‹å¼ç™¼ç”Ÿç•°å¸¸ï¼Œè«‹é‡è©¦ã€‚</p>
                                <button onClick={() => window.location.reload()} className="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">é‡æ–°æ•´ç†</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- åœ–ç¤ºçµ„ä»¶ ---
        const IconBase = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Icons = {
            Search: (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></IconBase>,
            Phone: (props) => <IconBase {...props}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></IconBase>,
            User: (props) => <IconBase {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></IconBase>,
            Building: (props) => <IconBase {...props}><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="9" y1="22" x2="9" y2="22.01"></line><line x1="15" y1="22" x2="15" y2="22.01"></line><line x1="9" y1="18" x2="9" y2="18.01"></line><line x1="15" y1="18" x2="15" y2="18.01"></line><line x1="9" y1="14" x2="9" y2="14.01"></line><line x1="15" y1="14" x2="15" y2="14.01"></line><line x1="9" y1="10" x2="9" y2="10.01"></line><line x1="15" y1="10" x2="15" y2="10.01"></line><line x1="9" y1="6" x2="9" y2="6.01"></line><line x1="15" y1="6" x2="15" y2="6.01"></line></IconBase>,
            Plus: (props) => <IconBase {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconBase>,
            Upload: (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></IconBase>,
            Trash2: (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconBase>,
            Edit2: (props) => <IconBase {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></IconBase>,
            Save: (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></IconBase>,
            X: (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></IconBase>,
            Download: (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></IconBase>,
            Settings: (props) => <IconBase {...props}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></IconBase>,
            ChevronUp: (props) => <IconBase {...props}><polyline points="18 15 12 9 6 15"></polyline></IconBase>,
            RotateCcw: (props) => <IconBase {...props}><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></IconBase>,
            HelpCircle: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></IconBase>,
            CloudUpload: (props) => <IconBase {...props}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></IconBase>,
            Broom: (props) => <IconBase {...props}><path d="M18 20a4.5 4.5 0 0 0 4.5-4.5V3h-3v12.5a1.5 1.5 0 0 1-1.5 1.5H5.5A1.5 1.5 0 0 1 4 15.5V3H1v12.5A4.5 4.5 0 0 0 5.5 20h12.5z"></path><line x1="10" y1="3" x2="10" y2="10"></line><line x1="14" y1="3" x2="14" y2="10"></line></IconBase>,
            Trash: (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></IconBase>,
        };
        const { Search, Phone, User, Building, Plus, Upload, Trash2, Edit2, Save, X, Download, Settings, ChevronUp, RotateCcw, HelpCircle, CloudUpload, Broom, Trash } = Icons;

        // --- é è¨­è³‡æ–™ (å®Œæ•´ç‰ˆ) ---
        const DEFAULT_DATA = [
            { id: '300', unit: 'æ¥­æœ¬éƒ¨', ext: '300', name: 'è‘£äº‹é•·', note: '' },
            { id: '301', unit: 'æ¥­æœ¬éƒ¨', ext: '301', name: 'é‚±éœæ€¡', note: '' },
            { id: '302', unit: 'æ¥­æœ¬éƒ¨', ext: '302', name: 'åŠ‰ä¼Šç¥', note: '#6940' },
            { id: '303', unit: 'æ¥­æœ¬éƒ¨', ext: '303', name: 'ç‹ä¿®å‡¡', note: '' },
            { id: '305', unit: 'æ¥­æœ¬éƒ¨', ext: '305', name: 'é«˜è‘£äº‹', note: '' },
            { id: '306', unit: 'æ¥­æœ¬éƒ¨', ext: '306', name: 'éƒ­å‰¯ç¸½', note: '' },
            { id: '307', unit: 'æ¥­æœ¬éƒ¨', ext: '307', name: 'è³´ç‰¹åŠ©', note: '' },
            { id: '308', unit: 'æ¥­æœ¬éƒ¨', ext: '308', name: 'æ½˜ç‰¹åŠ©', note: '' },
            { id: '311', unit: 'æ¥­æœ¬éƒ¨', ext: '311', name: 'é™³é¡§å•', note: '' },
            { id: '312', unit: 'æ¥­æœ¬éƒ¨', ext: '312', name: 'é„­ç‰¹åŠ©', note: '' },
            { id: '330', unit: 'æ¥­æœ¬éƒ¨', ext: '330', name: 'å³æ·‘è•™', note: '' },
            { id: '350', unit: 'æ¥­æœ¬éƒ¨', ext: '350', name: 'å¤§æœƒè­°å®¤', note: '' },
            { id: '351', unit: 'æ¥­æœ¬éƒ¨', ext: '351', name: 'æœƒè­°å®¤', note: '' },
            { id: '352', unit: 'æ¥­æœ¬éƒ¨', ext: '352', name: 'æœƒå®¢å®¤', note: '' },
            { id: '200', unit: 'ç­–ç•¥ä¼åŠƒéƒ¨', ext: '200', name: 'ç‹ç¸½ç¶“ç†', note: '' },
            { id: '202', unit: 'ç­–ç•¥ä¼åŠƒéƒ¨', ext: '202', name: 'ç‹çµ®å¹³', note: '' },
            { id: '203', unit: 'ç­–ç•¥ä¼åŠƒéƒ¨', ext: '203', name: 'å”è‚²å´§', note: '' },
            { id: '205', unit: 'ç­–ç•¥ä¼åŠƒéƒ¨', ext: '205', name: 'è¿°è·äººå“¡', note: '' },
            { id: '207', unit: 'ç­–ç•¥ä¼åŠƒéƒ¨', ext: '207', name: 'ç‹æ…ˆè‹‘', note: '' },
            { id: '208', unit: 'ç­–ç•¥ä¼åŠƒéƒ¨', ext: '208', name: 'éŸ‹ä¿Šæ–Œ', note: '' },
            { id: '230', unit: 'è³‡è¨Šå®¤', ext: '230', name: 'æç‚¯æ˜', note: '' },
            { id: '231', unit: 'è³‡è¨Šå®¤', ext: '231', name: 'é„­å‡±å‹»', note: '' },
            { id: '232', unit: 'è³‡è¨Šå®¤', ext: '232', name: 'æä½³é´»', note: '' },
            { id: '233', unit: 'è³‡è¨Šå®¤', ext: '233', name: 'è³‡è¨Šå®¤æ©Ÿæˆ¿', note: '' },
            { id: '500', unit: 'ç ”ç™¼éƒ¨', ext: '500', name: 'è¬ä¿Šå‚‘', note: '#6900' },
            { id: '501', unit: 'ç ”ç™¼éƒ¨', ext: '501', name: 'æ½˜äº­æº±', note: '' },
            { id: '502', unit: 'ç ”ç™¼éƒ¨', ext: '502', name: 'æ½˜æ·‘è²', note: '' },
            { id: '503', unit: 'ç ”ç™¼éƒ¨', ext: '503', name: 'é‚±ç™¾è±', note: '' },
            { id: '510', unit: 'ç ”ç™¼éƒ¨', ext: '510', name: 'é™³æ˜­å®‰', note: '#6927' },
            { id: '531', unit: 'ç ”ç™¼éƒ¨', ext: '531', name: 'å³ç‰æ°‘', note: '' },
            { id: '532', unit: 'ç ”ç™¼éƒ¨', ext: '532', name: 'é„§æ•è°', note: '' },
            { id: '533', unit: 'ç ”ç™¼éƒ¨', ext: '533', name: 'è‘‰å­æ­£/æ–¹æ–é”', note: '#6906' },
            { id: '540', unit: 'ç ”ç™¼éƒ¨', ext: '540', name: 'é™³ç¦ç³', note: '#6943' },
            { id: '541', unit: 'ç ”ç™¼éƒ¨', ext: '541', name: 'ç ”ç™¼4Fæœƒè­°å®¤', note: '' },
            { id: '542', unit: 'ç ”ç™¼éƒ¨', ext: '542', name: 'å¯¦é©—å®¤ä¸‰', note: '' },
            { id: '543', unit: 'ç ”ç™¼éƒ¨', ext: '543', name: 'è¨±å®¶ç‘‹', note: '' },
            { id: '545', unit: 'ç ”ç™¼éƒ¨', ext: '545', name: 'å³æ–‡æ°/è©¹å²³å‹³', note: '#6916/#6921' },
            { id: '546', unit: 'ç ”ç™¼éƒ¨', ext: '546', name: 'ç”°åŸè/è‘£å¿—é¾', note: '' },
            { id: '547', unit: 'ç ”ç™¼éƒ¨', ext: '547', name: 'è¬éƒå®‰/é¡å˜‰èˆˆ', note: '#6934' },
            { id: '570', unit: 'ç ”ç™¼éƒ¨', ext: '570', name: '5Fè²´é‡å„€å™¨å®¤', note: '' },
            { id: '571', unit: 'ç ”ç™¼éƒ¨', ext: '571', name: 'èŠå¿—æˆ', note: '' },
            { id: '572', unit: 'ç ”ç™¼éƒ¨', ext: '572', name: '5Få¯¦é©—å®¤å››', note: '' },
            { id: '573', unit: 'ç ”ç™¼éƒ¨', ext: '573', name: 'ç›§ç¾©é›„', note: '#6915' },
            { id: '575', unit: 'ç ”ç™¼éƒ¨', ext: '575', name: '5æ¨“EIå¯¦é©—å®¤', note: '' },
            { id: '101', unit: 'è³‡æèª²', ext: '101', name: 'æ¥Šæ­£å ‚', note: '#6705' },
            { id: '102', unit: 'è³‡æèª²', ext: '102', name: 'è”¡æ”¿ç©/é™³æ˜æ¯…', note: '' },
            { id: '103', unit: 'è³‡æèª²', ext: '103', name: 'éƒ­éˆºæº±', note: '' },
            { id: '105', unit: 'è³‡æèª²', ext: '105', name: 'ç¨‹è®Œè€', note: '' },
            { id: '610', unit: 'ç”Ÿç”¢éƒ¨ç¾å ´', ext: '610', name: 'ç”Ÿä¸€èª²æ§åˆ¶å®¤', note: '' },
            { id: '611', unit: 'ç”Ÿç”¢éƒ¨ç¾å ´', ext: '611', name: 'ç”Ÿä¸€èª²æ¡æ¨£å®¤', note: '' },
            { id: '620', unit: 'ç”Ÿç”¢éƒ¨ç¾å ´', ext: '620', name: 'ç”ŸäºŒèª²æ§åˆ¶å®¤', note: '' },
            { id: '621', unit: 'ç”Ÿç”¢éƒ¨ç¾å ´', ext: '621', name: 'ç”ŸäºŒèª²æ¡æ¨£å®¤', note: '' },
            { id: '630', unit: 'ç”Ÿç”¢éƒ¨ç¾å ´', ext: '630', name: 'ç”Ÿä¸‰èª²æ§åˆ¶å®¤', note: '' },
            { id: '751', unit: 'ç”Ÿç”¢éƒ¨ç¾å ´', ext: '751', name: 'å³æ”¿æ†²/é™¸é‡å¿—', note: '#6963/#6979' },
            { id: '752', unit: 'ç”Ÿç”¢éƒ¨ç¾å ´', ext: '752', name: 'æ—ä»æš/å³ç¬å©·', note: '#964' },
            { id: '210', unit: 'ç‡Ÿæ¥­éƒ¨-å…§éŠ·', ext: '210', name: 'è˜‡ä¿¡é¾', note: '#6880' },
            { id: '901', unit: 'å¤–éƒ¨å–®ä½', ext: '#6 110', name: 'æ°¸å®‰åˆ†é§æ‰€', note: '' },
            { id: '902', unit: 'å¤–éƒ¨å–®ä½', ext: '#6 119', name: 'æ°¸å®‰æ¶ˆé˜²éšŠ', note: '' },
            { id: '903', unit: 'å¤–éƒ¨å–®ä½', ext: '07-6212895', name: 'æ°¸å®‰æœå‹™ä¸­å¿ƒ', note: '' },
            { id: '904', unit: 'å…¬å…±è¨­æ–½', ext: '885', name: 'è¾¦å…¬å®¤å®¢æ¢¯å…§ç·š', note: '' },
            { id: '905', unit: 'å…¬å…±è¨­æ–½', ext: '695', name: 'æˆå“å€‰åº«è²¨æ¢¯', note: '' },
        ];

        // --- éª¨æ¶å±çµ„ä»¶ ---
        const SkeletonCard = () => (
            <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-3.5 flex items-center justify-between">
                <div className="flex items-center gap-3 w-full">
                    <div className="w-10 h-10 rounded-full skeleton shrink-0"></div>
                    <div className="min-w-0 flex-1 space-y-2">
                        <div className="h-4 w-24 skeleton rounded"></div>
                        <div className="h-3 w-16 skeleton rounded"></div>
                    </div>
                </div>
                <div className="h-6 w-10 skeleton rounded ml-2"></div>
            </div>
        );

        // --- ContactModal å®šç¾© (ç§»åˆ° App ä¹‹å‰) ---
        const ContactModal = ({ isOpen, onClose, onSave, initialData, existingUnits = [] }) => {
            const [formData, setFormData] = useState({ unit: '', ext: '', name: '', note: '' });
            useEffect(() => { 
                if (initialData) { 
                    setFormData(initialData); 
                } else { 
                    setFormData({ unit: '', ext: '', name: '', note: '' }); 
                } 
            }, [initialData]);
            
            const handleSubmit = (e) => { e.preventDefault(); onSave({ ...formData, id: initialData?.id }); };
            
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50"><h3 className="font-bold text-lg text-slate-800">{initialData ? 'ç·¨è¼¯è¯çµ¡äºº' : 'æ–°å¢è¯çµ¡äºº'}</h3><button onClick={onClose} type="button" className="text-slate-400 hover:text-slate-600"><X className="w-5 h-5" /></button></div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                        <div><label className="block text-sm font-medium text-slate-700 mb-1">éƒ¨é–€ / å–®ä½</label><div className="relative"><div className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"><Building className="w-4 h-4" /></div><input required type="text" list="units-datalist" className="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šè³‡è¨Šå®¤" value={formData.unit || ''} onChange={e => setFormData({...formData, unit: e.target.value})} /><datalist id="units-datalist">{existingUnits.map(u => <option key={u} value={u} />)}</datalist></div></div>
                        <div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-slate-700 mb-1">ä½¿ç”¨äººå§“å</label><div className="relative"><div className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"><User className="w-4 h-4" /></div><input required type="text" className="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="å§“å" value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})} /></div></div><div><label className="block text-sm font-medium text-slate-700 mb-1">åˆ†æ©Ÿè™Ÿç¢¼</label><div className="relative"><div className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"><Phone className="w-4 h-4" /></div><input required type="text" className="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼š300" value={formData.ext || ''} onChange={e => setFormData({...formData, ext: e.target.value})} /></div></div></div>
                        <div><label className="block text-sm font-medium text-slate-700 mb-1">å‚™è¨» (é¸å¡«)</label><textarea className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" rows="2" placeholder="ä¾‹å¦‚ï¼šæ‰‹æ©Ÿè™Ÿç¢¼ã€è·å‹™ä»£ç†äºº..." value={formData.note || ''} onChange={e => setFormData({...formData, note: e.target.value})}></textarea></div>
                        <div className="pt-4 flex justify-end gap-3"><button type="button" onClick={onClose} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">å–æ¶ˆ</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md hover:shadow-lg transition flex items-center gap-2"><Save className="w-4 h-4" /> å„²å­˜</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- ä¸»æ‡‰ç”¨ç¨‹å¼ (App) ---
        const App = () => {
            const [contacts, setContacts] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedUnit, setSelectedUnit] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingContact, setEditingContact] = useState(null);
            const [encoding, setEncoding] = useState('big5');
            const [showFormatHint, setShowFormatHint] = useState(false);
            const [isManageMode, setIsManageMode] = useState(false); 
            const [imageError, setImageError] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [isUploading, setIsUploading] = useState(false);
            
            // ä½¿ç”¨è€…ç™»å…¥ç‹€æ…‹ (è§£æ±ºæ¬Šé™å•é¡Œ)
            const [user, setUser] = useState(null);

            // åˆå§‹åŒ– Auth
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    if (u) {
                        console.log("User signed in:", u.uid);
                        setUser(u);
                    } else {
                        console.log("No user, attempting anonymous sign in...");
                        auth.signInAnonymously().catch((error) => {
                            console.error("Anonymous auth failed:", error);
                            let errorMsg = `é€£ç·šå¤±æ•—: ${error.message}`;
                            if (error.code === 'auth/configuration-not-found') {
                                errorMsg = "Firebase Authentication å°šæœªå•Ÿç”¨ã€‚\n\nè«‹å‰å¾€ Firebase Console -> Authentication é é¢ï¼Œé»æ“Šã€Œé–‹å§‹ä½¿ç”¨ (Get Started)ã€ï¼Œä¸¦ç¢ºèªå·²é–‹å•Ÿã€ŒåŒ¿å (Anonymous)ã€ç™»å…¥ã€‚";
                            } else if (error.code === 'auth/operation-not-allowed') {
                                errorMsg = "åŒ¿åç™»å…¥æœªé–‹å•Ÿã€‚\n\nè«‹å‰å¾€ Firebase Console -> Authentication -> Sign-in methodï¼Œé–‹å•Ÿã€ŒåŒ¿å (Anonymous)ã€ã€‚";
                            }
                            alert(errorMsg);
                        });
                    }
                });
                return () => unsubscribe();
            }, []);

            // ä½¿ç”¨ Firestore ç›£è½è³‡æ–™
            useEffect(() => {
                if (!user) return;

                setIsLoading(true);
                const unsubscribe = db.collection(COLLECTION_NAME).orderBy('unit').onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    data.sort((a, b) => {
                        const unitA = a.unit || '';
                        const unitB = b.unit || '';
                        if (unitA !== unitB) return unitA.localeCompare(unitB, 'zh-TW');
                        const extA = a.ext || '';
                        const extB = b.ext || '';
                        return extA.localeCompare(extB);
                    });

                    setContacts(data);
                    setIsLoading(false);
                }, (error) => {
                    console.error("Firebase Snapshot error:", error);
                    setIsLoading(false);
                    if (error.code !== 'permission-denied') {
                        alert("è³‡æ–™è®€å–éŒ¯èª¤: " + error.message);
                    }
                });

                return () => unsubscribe();
            }, [user]);

            const allUnits = useMemo(() => {
                const units = [...new Set(contacts.map(c => c.unit || '').filter(u => u && u.trim() !== ''))];
                return units.sort();
            }, [contacts]);

            const parseCSV = (text) => {
                const lines = text.split('\n');
                const newContacts = [];
                let mode = 'unknown';
                const firstLine = lines[0]?.trim();
                if (firstLine && firstLine.split(',').length > 6) { mode = 'legacy'; } else { mode = 'standard'; }
                lines.forEach((line, index) => {
                    const cleanLine = line.replace('\r', '');
                    if (!cleanLine.trim()) return;
                    const row = cleanLine.split(',').map(cell => cell.trim().replace(/^"|"$/g, ''));
                    if (mode === 'legacy') {
                        for (let i = 0; i < row.length; i += 4) {
                            const unit = row[i]?.trim(); let ext = row[i+1]?.trim(); const nameRaw = row[i+2]?.trim();
                            if (unit && ext && nameRaw && unit !== 'å–®ä½' && ext !== 'åˆ†æ©Ÿ') {
                                ext = ext.replace('.0', ''); 
                                newContacts.push({ 
                                    unit: unit || '', 
                                    ext: ext || '', 
                                    name: nameRaw || '', 
                                    note: '' 
                                });
                            }
                        }
                    } else {
                        const col0 = row[0]; const col1 = row[1]; let name = col1; let ext = row[2]; let note = row[3];
                        if (col1 && !isNaN(col1) && isNaN(row[2])) { ext = col1; name = row[2]; } else if (col1 && col1.includes('åˆ†æ©Ÿ')) { return; }
                        if (col0 && name && ext) { 
                            if (['éƒ¨é–€', 'å–®ä½', 'Unit'].includes(col0) || ['åˆ†æ©Ÿ'].includes(ext)) return; 
                            newContacts.push({ 
                                unit: col0 || '', 
                                name: name || '', 
                                ext: ext.replace('.0', '') || '', 
                                note: note || '' 
                            }); 
                        }
                    }
                });
                return { contacts: newContacts, mode };
            };

            const batchUploadToFirebase = async (dataToUpload) => {
                if (!user) {
                    alert("å°šæœªé€£ç·šåˆ°è³‡æ–™åº«ï¼Œè«‹ç¨å¾Œå†è©¦");
                    return;
                }
                if (dataToUpload.length === 0) return;
                
                setIsUploading(true);
                try {
                    const batch = db.batch();
                    let addedCount = 0;
                    let updatedCount = 0;
                    const BATCH_SIZE = 450; 

                    const existingMap = new Map();
                    contacts.forEach(c => {
                        const key = `${c.name}-${c.ext}`.replace(/\s/g, '').toLowerCase();
                        existingMap.set(key, c.id);
                    });

                    for (const contact of dataToUpload) {
                        const key = `${contact.name}-${contact.ext}`.replace(/\s/g, '').toLowerCase();
                        const { id, ...data } = contact; 

                        if (existingMap.has(key)) {
                            const docId = existingMap.get(key);
                            const ref = db.collection(COLLECTION_NAME).doc(docId);
                            batch.update(ref, data);
                            updatedCount++;
                        } else {
                            const newRef = db.collection(COLLECTION_NAME).doc();
                            batch.set(newRef, data);
                            addedCount++;
                            existingMap.set(key, newRef.id);
                        }
                        
                        if ((addedCount + updatedCount) >= BATCH_SIZE) break; 
                    }

                    if ((addedCount + updatedCount) > 0) {
                        await batch.commit();
                        alert(`è™•ç†å®Œæˆï¼\nğŸ†• æ–°å¢è³‡æ–™ï¼š${addedCount} ç­†\nğŸ”„ æ›´æ–°è³‡æ–™ï¼š${updatedCount} ç­†`);
                    } else {
                        alert(`æœªé€²è¡Œä»»ä½•è®Šæ›´ (è³‡æ–™å®Œå…¨ä¸€è‡´)`);
                    }
                    
                } catch (error) {
                    console.error("Upload error:", error);
                    alert("ä¸Šå‚³å¤±æ•—ï¼š" + error.message);
                } finally {
                    setIsUploading(false);
                }
            };

            const cleanDuplicates = async () => {
                if (!user) return;
                if (!window.confirm("ç¢ºå®šè¦åŸ·è¡Œã€Œå¼·åŠ›å»é‡ã€å—ï¼Ÿ\n\nç³»çµ±å°‡æƒææ•´å€‹è³‡æ–™åº«ï¼Œè‹¥ç™¼ç¾ã€Œå§“å+åˆ†æ©Ÿã€ç›¸åŒï¼Œå°‡åªä¿ç•™ä¸€ç­†ï¼Œå…¶é¤˜åˆªé™¤ã€‚\n(æœƒå¿½ç•¥éƒ¨é–€åç¨±çš„å·®ç•°)")) return;

                setIsUploading(true);
                try {
                    const snapshot = await db.collection(COLLECTION_NAME).get();
                    const allDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    const seenSignatures = new Set();
                    const batch = db.batch();
                    let deleteCount = 0;
                    const BATCH_SIZE = 450; 

                    for (const doc of allDocs) {
                        const cleanName = String(doc.name || '').replace(/\s/g, '').toLowerCase();
                        const cleanExt = String(doc.ext || '').replace(/\.0$/, '').replace(/\s/g, '');
                        const signature = `${cleanName}-${cleanExt}`;
                        
                        if (seenSignatures.has(signature)) {
                            const ref = db.collection(COLLECTION_NAME).doc(doc.id);
                            batch.delete(ref);
                            deleteCount++;
                            if (deleteCount >= BATCH_SIZE) break; 
                        } else {
                            seenSignatures.add(signature);
                        }
                    }

                    if (deleteCount > 0) {
                        await batch.commit();
                        alert(`æ¸…ç†å®Œæˆï¼\nå…±ç§»é™¤äº† ${deleteCount} ç­†é‡è¤‡è³‡æ–™ã€‚`);
                    } else {
                        alert("è³‡æ–™åº«å¾ˆä¹¾æ·¨ï¼Œæ²’æœ‰ç™¼ç¾é‡è¤‡è³‡æ–™ã€‚");
                    }

                } catch (error) {
                    console.error("Clean error:", error);
                    alert("æ¸…ç†å¤±æ•—ï¼š" + error.message);
                } finally {
                    setIsUploading(false);
                }
            };

            const deleteAllData = async () => {
                if (!user) return;
                if (!window.confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡æœƒã€Œæ°¸ä¹…åˆªé™¤ã€è³‡æ–™åº«ä¸­çš„æ‰€æœ‰è¯çµ¡äººè³‡æ–™ï¼\n\næ‚¨ç¢ºå®šè¦æ¸…ç©ºå—ï¼Ÿ")) return;
                const confirm2 = prompt("è«‹è¼¸å…¥ 'DELETE' (å¤§å¯«) ä»¥ç¢ºèªåˆªé™¤æ‰€æœ‰è³‡æ–™ï¼š");
                if (confirm2 !== 'DELETE') return;

                setIsUploading(true);
                try {
                    const snapshot = await db.collection(COLLECTION_NAME).get();
                    if (snapshot.empty) {
                        alert("è³‡æ–™åº«å·²ç¶“æ˜¯ç©ºçš„äº†ã€‚");
                        setIsUploading(false);
                        return;
                    }

                    const batch = db.batch();
                    let count = 0;
                    const BATCH_SIZE = 450;

                    snapshot.docs.forEach((doc) => {
                        if (count < BATCH_SIZE) {
                            batch.delete(doc.ref);
                            count++;
                        }
                    });

                    await batch.commit();
                    alert(`å·²æ¸…ç©º ${count} ç­†è³‡æ–™ã€‚\n(è‹¥è³‡æ–™é‡è¶…é 450 ç­†ï¼Œè«‹å†æ¬¡åŸ·è¡Œæ­¤åŠŸèƒ½ä»¥åˆªé™¤å‰©é¤˜è³‡æ–™)`);

                } catch (error) {
                    console.error("Delete all error:", error);
                    alert("æ¸…ç©ºå¤±æ•—ï¼š" + error.message);
                } finally {
                    setIsUploading(false);
                }
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader(); reader.readAsText(file, encoding);
                reader.onload = (e) => {
                    const text = e.target.result;
                    if (text.includes('') && text.length > 20) { alert('è­¦å‘Šï¼šåµæ¸¬åˆ°äº‚ç¢¼ï¼Œè«‹å˜—è©¦åˆ‡æ›ã€Œç·¨ç¢¼æ ¼å¼ã€å¾Œé‡æ–°åŒ¯å…¥ã€‚'); }
                    const { contacts: newContacts, mode } = parseCSV(text);
                    if (newContacts.length > 0) {
                        const msg = mode === 'legacy' ? `åµæ¸¬åˆ°ã€ŒèˆŠç‰ˆæ’ç‰ˆæ ¼å¼ã€ï¼Œè§£æå‡º ${newContacts.length} ç­†è³‡æ–™ã€‚` : `åµæ¸¬åˆ°ã€Œæ¨™æº–æ¸…å–®æ ¼å¼ã€ï¼Œè§£æå‡º ${newContacts.length} ç­†è³‡æ–™ã€‚`;
                        if (window.confirm(`${msg}\nç¢ºå®šè¦å°‡é€™äº›è³‡æ–™ã€Œåˆä½µæ›´æ–°ã€åˆ°é›²ç«¯è³‡æ–™åº«å—ï¼Ÿ\n(ç›¸åŒå§“å+åˆ†æ©Ÿçš„è³‡æ–™å°‡æœƒè¢«æ›´æ–°)`)) { batchUploadToFirebase(newContacts); } setSelectedUnit(null);
                    } else { alert('è§£æå¤±æ•—ã€‚è«‹ç¢ºèªæª”æ¡ˆç·¨ç¢¼æ˜¯å¦æ­£ç¢ºï¼Œæˆ–æª”æ¡ˆå…§å®¹æ˜¯å¦ç¬¦åˆæ ¼å¼ã€‚'); }
                };
            };
            const filteredContacts = useMemo(() => {
                const lowerSearch = searchTerm.toLowerCase();
                return contacts.filter(contact => {
                    const matchesUnit = selectedUnit ? contact.unit === selectedUnit : true;
                    const cName = contact.name || '';
                    const cExt = contact.ext || '';
                    const cUnit = contact.unit || '';
                    const cNote = contact.note || '';
                    const matchesSearch = cName.toLowerCase().includes(lowerSearch) || 
                                          cExt.includes(lowerSearch) || 
                                          cUnit.toLowerCase().includes(lowerSearch) || 
                                          cNote.toLowerCase().includes(lowerSearch);
                    return matchesUnit && matchesSearch;
                });
            }, [contacts, searchTerm, selectedUnit]);
            
            const handleDelete = async (id) => { if (window.confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¯çµ¡äººå—ï¼Ÿ(æ­¤æ“ä½œæœƒåŒæ­¥åˆªé™¤é›²ç«¯è³‡æ–™)')) { try { await db.collection(COLLECTION_NAME).doc(id).delete(); } catch (err) { alert("åˆªé™¤å¤±æ•—ï¼š" + err.message); } } };
            const handleSave = async (contact) => { try { if (contact.id) { const { id, ...data } = contact; await db.collection(COLLECTION_NAME).doc(id).set(data, { merge: true }); } else { const { id, ...data } = contact; await db.collection(COLLECTION_NAME).add(data); } setIsModalOpen(false); setEditingContact(null); } catch (err) { alert("å„²å­˜å¤±æ•—ï¼š" + err.message); } };
            const openAddModal = () => { setEditingContact(null); setIsModalOpen(true); };
            const openEditModal = (contact) => { setEditingContact(contact); setIsModalOpen(true); };
            const handleInitDefaultData = () => { if (window.confirm("é€™å°‡æœƒæŠŠå…§å»ºçš„é è¨­è³‡æ–™(PDFå…§å®¹)å…¨éƒ¨ä¸Šå‚³åˆ° Firebaseã€‚\nå¦‚æœè³‡æ–™åº«å·²ç¶“æœ‰è³‡æ–™ï¼Œå¯èƒ½æœƒé€ æˆé‡è¤‡ã€‚\nç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ")) { batchUploadToFirebase(DEFAULT_DATA); } };
            const exportCSV = () => { const header = "éƒ¨é–€,å§“å,åˆ†æ©Ÿ,å‚™è¨»\n"; const rows = contacts.map(c => `${c.unit || ''},${c.name || ''},${c.ext || ''},${c.note || ''}`).join("\n"); const blob = new Blob(["\ufeff" + header + rows], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.setAttribute('download', 'å…¬å¸é€šè¨ŠéŒ„_é›²ç«¯å‚™ä»½.csv'); document.body.appendChild(link); link.click(); document.body.removeChild(link); };

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-12">
                    <ErrorBoundary>
                        <header className="bg-blue-600 text-white shadow-md sticky top-0 z-20">
                            <div className="max-w-6xl mx-auto px-4 py-3">
                                <div className="flex justify-between items-center mb-3">
                                    {/* Logo å€åŸŸ - å¼·åˆ¶é‡æ–°è¼‰å…¥ icon.png */}
                                    <h1 
                                        className="text-xl font-bold flex items-center gap-3 cursor-pointer hover:opacity-90 transition" 
                                        onClick={() => {setSelectedUnit(null); setSearchTerm('')}}
                                    >
                                        {!imageError ? (
                                            <img 
                                                src="icon.png?v=3" 
                                                alt="Logo" 
                                                className="w-8 h-8 object-contain rounded-lg bg-white/10 p-0.5" 
                                                onError={() => {
                                                    setImageError(true);
                                                }}
                                            />
                                        ) : (
                                            <Phone className="w-6 h-6" />
                                        )}
                                        <span>å…¬å¸åˆ†æ©Ÿè¡¨</span>
                                    </h1>
                                    
                                    <div className="flex items-center gap-2">
                                        {isLoading && <div className="loader mr-2"></div>}
                                        <button 
                                            onClick={() => setIsManageMode(!isManageMode)}
                                            className={`p-2 rounded-lg transition text-blue-100 hover:bg-blue-500 hover:text-white ${isManageMode ? 'bg-blue-700 text-white' : ''}`}
                                            title="ç®¡ç†è³‡æ–™"
                                        >
                                            {isManageMode ? <ChevronUp className="w-5 h-5" /> : <Settings className="w-5 h-5" />}
                                        </button>
                                    </div>
                                </div>

                                <div className="relative w-full">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <Search className="h-4 w-4 text-blue-200" />
                                    </div>
                                    <input
                                        type="text"
                                        className="block w-full pl-9 pr-8 py-2.5 border-none rounded-lg leading-5 bg-blue-700/50 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-white focus:bg-blue-600 sm:text-sm transition duration-150 ease-in-out"
                                        placeholder="æœå°‹å§“åã€åˆ†æ©Ÿæˆ–éƒ¨é–€..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                    {searchTerm && (
                                        <button 
                                            onClick={() => setSearchTerm('')}
                                            className="absolute inset-y-0 right-0 pr-2.5 flex items-center text-blue-300 hover:text-white"
                                        >
                                            <X className="w-4 h-4" />
                                        </button>
                                    )}
                                </div>
                            </div>
                        </header>

                        {/* ç®¡ç†é¢æ¿èˆ‡åˆ—è¡¨å€åŸŸ (ä¿æŒä¸è®Š) */}
                        <div className={`bg-white border-b border-slate-200 overflow-hidden transition-all duration-300 ease-in-out ${isManageMode ? 'max-h-96 opacity-100' : 'max-h-0 opacity-0'}`}>
                            <div className="max-w-6xl mx-auto px-4 py-4 space-y-4">
                                <h3 className="text-sm font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                                    <Settings className="w-4 h-4" /> è³‡æ–™ç®¡ç† (Firebase é›²ç«¯ç‰ˆ)
                                </h3>
                                <div className="text-xs text-slate-400 mb-2">Version: {APP_VERSION}</div>

                                <div className="flex flex-wrap gap-3 items-center">
                                    <button onClick={openAddModal} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm transition shadow-sm"><Plus className="w-4 h-4" /> æ–°å¢</button>
                                    <div className="h-6 w-px bg-slate-300 mx-1 hidden sm:block"></div>
                                    <label className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-lg cursor-pointer hover:bg-slate-50 text-slate-600 text-sm transition shadow-sm">
                                        {isUploading ? <div className="loader w-4 h-4 border-slate-400"></div> : <Upload className="w-4 h-4" />}
                                        <span>{isUploading ? "ä¸Šå‚³ä¸­..." : "åŒ¯å…¥ CSV"}</span>
                                        <input key={encoding} type="file" accept=".csv,.txt" className="hidden" onChange={handleFileUpload} disabled={isUploading} />
                                    </label>
                                    <div className="flex items-center bg-slate-50 border border-slate-300 rounded-lg px-2 py-1.5 shadow-sm">
                                        <span className="text-xs text-slate-500 mr-2">CSVç·¨ç¢¼:</span>
                                        <select value={encoding} onChange={(e) => setEncoding(e.target.value)} className="text-sm bg-transparent border-none focus:ring-0 text-slate-700 cursor-pointer outline-none p-0"><option value="big5">Big5 (Excel)</option><option value="utf-8">UTF-8</option></select>
                                    </div>
                                    <button onClick={exportCSV} className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 text-slate-600 text-sm transition shadow-sm"><Download className="w-4 h-4" /> åŒ¯å‡º</button>
                                    <div className="h-6 w-px bg-slate-300 mx-1 hidden sm:block"></div>
                                    
                                    {/* æ–°å¢ï¼šæ¸…é™¤é‡è¤‡è³‡æ–™æŒ‰éˆ• */}
                                    <button onClick={cleanDuplicates} className="flex items-center gap-2 px-4 py-2 bg-orange-50 text-orange-700 border border-orange-200 rounded-lg hover:bg-orange-100 text-sm transition shadow-sm" disabled={isUploading} title="æ¸…é™¤è³‡æ–™åº«ä¸­å·²å­˜åœ¨çš„é‡è¤‡è³‡æ–™">
                                        <Broom className="w-4 h-4" />
                                        å¼·åŠ›æ¸…é™¤é‡è¤‡
                                    </button>

                                    {/* æ–°å¢ï¼šæ¸…ç©ºè³‡æ–™æŒ‰éˆ• */}
                                    <button onClick={deleteAllData} className="flex items-center gap-2 px-4 py-2 bg-red-50 text-red-700 border border-red-200 rounded-lg hover:bg-red-100 text-sm transition shadow-sm" disabled={isUploading} title="åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼Œæ…ç”¨ï¼">
                                        <Trash className="w-4 h-4" />
                                        æ¸…ç©ºæ‰€æœ‰è³‡æ–™
                                    </button>

                                    <button onClick={handleInitDefaultData} className="flex items-center gap-2 px-4 py-2 bg-green-50 text-green-700 border border-green-200 rounded-lg hover:bg-green-100 text-sm transition shadow-sm" disabled={isUploading}><CloudUpload className="w-4 h-4" /> ä¸Šå‚³é è¨­è³‡æ–™</button>
                                    <button onClick={() => setShowFormatHint(!showFormatHint)} className="p-2 text-slate-400 hover:text-blue-600 transition ml-auto"><HelpCircle className="w-5 h-5" /></button>
                                </div>
                                {showFormatHint && (
                                    <div className="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-slate-700 animate-in fade-in slide-in-from-top-2">
                                        <p className="mb-2 font-bold text-blue-800">ğŸ’¡ å»ºè­° CSV æ¬„ä½é †åº (4æ¬„):</p>
                                        <p className="text-xs text-slate-600">A:éƒ¨é–€ | B:å§“å | C:åˆ†æ©Ÿ | D:å‚™è¨»</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        <main className="max-w-6xl mx-auto px-4 pt-4">
                            {isLoading ? (
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                    {Array(9).fill(0).map((_, i) => <SkeletonCard key={i} />)}
                                </div>
                            ) : (
                                <>
                                    {contacts.length === 0 ? (
                                        <div className="text-center py-12 bg-white rounded-lg border border-dashed border-slate-300 fade-in">
                                            <p className="text-slate-500 mb-4">è³‡æ–™åº«ç›®å‰æ˜¯ç©ºçš„</p>
                                            <button onClick={handleInitDefaultData} className="text-blue-600 hover:underline font-bold">é»æ­¤ä¸Šå‚³é è¨­è³‡æ–™ (PDFå…§å®¹)</button>
                                        </div>
                                    ) : (
                                        <>
                                            {/* éƒ¨é–€ç¯©é¸ (æ–¹æ ¼ç‰ˆ) */}
                                            {allUnits.length > 0 && (
                                                <div className="mb-6 fade-in">
                                                    <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2">
                                                        <button 
                                                            onClick={() => setSelectedUnit(null)} 
                                                            className={`px-2 py-3 rounded-lg text-sm font-medium transition-colors border text-center ${!selectedUnit ? 'bg-slate-800 text-white border-slate-800 shadow-sm scale-[1.02]' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-100'}`}
                                                        >
                                                            å…¨éƒ¨
                                                        </button>
                                                        {allUnits.map(unit => {
                                                            const isSelected = selectedUnit === unit;
                                                            return ( 
                                                                <button 
                                                                    key={unit} 
                                                                    onClick={() => setSelectedUnit(unit)} 
                                                                    className={`px-2 py-3 rounded-lg text-sm font-medium transition-colors border text-center truncate ${isSelected ? 'bg-blue-600 text-white border-blue-600 shadow-sm scale-[1.02]' : 'bg-white text-slate-600 border-slate-200 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200'}`} 
                                                                    title={unit}
                                                                >
                                                                    {unit}
                                                                </button> 
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            )}

                                            {/* ç¯©é¸çµæœç‹€æ…‹ */}
                                            {(selectedUnit || searchTerm) && (
                                                <div className="flex items-center justify-between mb-4 text-sm text-slate-500 px-1 fade-in">
                                                    <div className="flex items-center gap-2">
                                                        <span>{selectedUnit && `ğŸ“‚ ${selectedUnit}`}{selectedUnit && searchTerm && ' + '}{searchTerm && `ğŸ” "${searchTerm}"`}</span>
                                                        <span className="text-xs bg-slate-100 px-2 py-0.5 rounded-full">{filteredContacts.length} ç­†</span>
                                                    </div>
                                                    <button onClick={() => {setSelectedUnit(null); setSearchTerm('');}} className="text-xs text-blue-500 hover:underline flex items-center gap-1"><RotateCcw className="w-3 h-3" /> æ¸…é™¤</button>
                                                </div>
                                            )}

                                            {/* è¯çµ¡äººå¡ç‰‡åˆ—è¡¨ */}
                                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 fade-in">
                                                {filteredContacts.length > 0 ? (
                                                    filteredContacts.map((contact) => (
                                                        <div key={contact.id} className="bg-white rounded-lg shadow-sm border border-slate-200 p-3.5 flex items-center justify-between hover:shadow-md transition duration-200 group relative">
                                                            <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200 bg-white/90 backdrop-blur-sm rounded-lg p-1 shadow-sm border border-slate-100">
                                                                <button onClick={() => openEditModal(contact)} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-md transition-colors" title="ç·¨è¼¯"><Edit2 className="w-3.5 h-3.5" /></button>
                                                                <button onClick={() => handleDelete(contact.id)} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-md transition-colors" title="åˆªé™¤"><Trash2 className="w-3.5 h-3.5" /></button>
                                                            </div>
                                                            <div className="flex items-center gap-3 overflow-hidden">
                                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold shrink-0 text-white text-sm shadow-sm ${selectedUnit === contact.unit ? 'bg-blue-500' : 'bg-slate-400'}`}>{(contact.name || '?').charAt(0)}</div>
                                                                <div className="min-w-0">
                                                                    <h3 className="font-bold text-slate-800 truncate">{contact.name || 'æœªå‘½å'}</h3>
                                                                    <div className="text-xs text-slate-500 truncate flex items-center gap-1">{contact.unit || ''}{contact.note && <span className="text-slate-300">|</span>}{contact.note && <span className="text-orange-400">{contact.note}</span>}</div>
                                                                </div>
                                                            </div>
                                                            <div className="pl-2 text-right">
                                                                <a href={`tel:${(contact.ext || '').split('#')[0]}`} className="block text-xl font-bold text-blue-600 font-mono hover:underline decoration-2 underline-offset-2">{contact.ext || ''}</a>
                                                            </div>
                                                        </div>
                                                    ))
                                                ) : (
                                                    <div className="col-span-full py-10 text-center text-slate-400"><p>æŸ¥ç„¡è³‡æ–™</p></div>
                                                )}
                                            </div>
                                        </>
                                    )}
                                </>
                            )}
                        </main>

                        {isModalOpen && <ContactModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSave} initialData={editingContact} existingUnits={allUnits} />}
                    </ErrorBoundary>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
